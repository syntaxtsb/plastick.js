/*!
 * plastick.js v0.4.1 2017-01-19T22:44:27-0500
 * https://github.com/syntaxtsb/plastick.js
 * 
 * Copyright (c) 2017 Travis Beebe
 * Released under the MIT license.
 */
!function(){"use strict";function a(a){this.TARGET_TPS=30,this.TICK_CHOKE=50,void 0!==a.getContext?(this.canvasMode="native canvas",this.canvas=a,this.context=a.getContext("2d")):(this.canvasMode="facade",this.facade=a,this.canvas=a.canvas,this.context=a.context),this.HDPIMode=1,this.data={},this.methods={},this.states=[],this.startTime=null,this.currentTick=0,this.tickTime=0,this.tickAlpha=0,this.freezeOnBlur=!0,this._isRunning=!1,this._freezeStart=null,this._frameTime=0,this._freezeLength=0,this._debugMode=!1,this._debugStopGameEvent=function(a){32===a.keyCode&&a.shiftKey&&(a.preventDefault(),this.stop())}.bind(this),document.addEventListener(c,this._freeze.bind(this))}!function(){if(window.performance=window.performance||{},!window.performance.now){var a=Date.now();window.performance.now=function(){return Date.now()-a}}}();var b,c;"undefined"!==document.hidden?(b="hidden",c="visibilitychange"):"undefined"!==document.mozHidden?(b="mozHidden",c="mozvisibilitychange"):"undefined"!==document.msHidden?(b="msHidden",c="msvisibilitychange"):"undefined"!==document.webkitHidden&&(b="webkitHidden",c="webkitvisibilitychange"),a.prototype.setHDPIMode=function(a){"boolean"==typeof a?this.HDPIMode=a?2:1:"number"==typeof a?this.HDPIMode=a:this.HDPIMode=1,"native canvas"===this.canvasMode?(this.canvas.setAttribute("style","width: "+this.canvas.width+"px; height: "+this.canvas.height+"px;"),this.canvas.setAttribute("width",this.canvas.width*this.HDPIMode),this.canvas.setAttribute("height",this.canvas.height*this.HDPIMode),this.context.scale(this.HDPIMode,this.HDPIMode),this.canvas.setAttribute("data-resized-for-hdpi",!0)):this.facade.resizeForHDPI(this.HDPIMode)},a.prototype.start=function(b){var c=this.isRunning();return b instanceof a.State&&!c?(this._isRunning=!0,this.startTime=window.performance.now(),this.tickTime=0,this._frameTime=0,this.states.push(b),this._debugMode&&this.debug("Game started, using "+this.canvasMode+" ("+this.currentState().name+")"),this._createEventListeners(b),b._init(this),"native canvas"===this.canvasMode?window.requestAnimationFrame(this._requestAnimationFrame.bind(this)):this.facade.draw(this._gameLoop.bind(this)),!0):b instanceof a.State&&!this.wasRunning},a.prototype.stop=function(){var a=this.isRunning();return a&&(this._isRunning=!1,"facade"===this.canvasMode&&this.facade.stop(),this._cleanup(),this._debugMode&&this.debug("Game stopped")),a},a.prototype.isRunning=function(){return this._isRunning},a.prototype.pushState=function(b){var c=this.currentState();return c&&b instanceof a.State&&(c._pause(this),this._destroyEventListeners(c),this.states.push(b),this._debugMode&&this.debug("Pushed state ("+c.name+" -> "+this.currentState().name+")"),this._createEventListeners(b),b._init(this)),b instanceof a.State},a.prototype.popState=function(){var a,b=this.states.pop();return b&&(b._cleanup(this),this._destroyEventListeners(b)),a=this.currentState(),a?(this._debugMode&&this.debug("Popped state ("+b.name+" -> "+this.currentState().name+")"),this._createEventListeners(a),a._resume(this)):(this._debugMode&&this.debug("Popped state ("+b.name+" -> [empty])"),this.stop()),void 0!==b},a.prototype.changeState=function(b){var c=this.currentState();return c&&b instanceof a.State&&(this.states.pop(),c._cleanup(this),this._destroyEventListeners(c),this.states.push(b),this._debugMode&&this.debug("Changed state ("+c.name+" -> "+this.currentState().name+")"),this._createEventListeners(b),b._init(this)),void 0!==c&&b instanceof a.State},a.prototype.currentState=function(){return this.states[this.states.length-1]},a.prototype.gameTime=function(a){return a?a-this.startTime-this._freezeLength:window.performance.now()-this.startTime-this._freezeLength},a.prototype.lerp=function(a,b,c){return void 0===c&&(c=this.tickAlpha),(b-a)*c+a},a.prototype.width=function(){return"facade"!==this.canvasMode?this.canvas.width/this.HDPIMode:void this.facade.width()},a.prototype.height=function(){return"facade"!==this.canvasMode?this.canvas.height/this.HDPIMode:void this.facade.height()},a.prototype.setDebug=function(a){a===!0&&this._debugMode===!1?(this._debugMode=!0,document.addEventListener("keydown",this._debugStopGameEvent)):a===!1&&this._debugMode===!0&&(this._debugMode=!1,document.removeEventListener("keydown",this._debugStopGameEvent))},a.prototype.debug=function(a){this._debugMode&&console.info("Plastick ("+this.currentTick+" @ "+(+this.gameTime()/1e3).toFixed(3)+"s): "+a)},a.prototype._cleanup=function(){for(;this.states.length;)this.popState();return!0},a.prototype._freeze=function(){this.freezeOnBlur&&document[b]&&this.isRunning()&&(this._freezeStart=window.performance.now(),this._destroyEventListeners(this.currentState())),this.freezeOnBlur&&!document[b]&&this.isRunning()&&(this._freezeLength+=window.performance.now()-this._freezeStart,this._freezeStart=null,this._createEventListeners(this.currentState()))},a.prototype._createEventListeners=function(a){a.listeners.forEach(function(a){a.element.addEventListener(a.eventType,a.callback)})},a.prototype._destroyEventListeners=function(a){a.listeners.forEach(function(a){a.element.removeEventListener(a.eventType,a.callback)})},a.prototype._gameLoop=function(){var a=0,b=this.currentState();for(this._frameTime=this.gameTime();this._frameTime*this.TARGET_TPS/1e3>this.currentTick&&a<this.TICK_CHOKE&&this._isRunning;)this.currentTick+=1,a+=1,this.currentState()._update(this),this.tickTime=this.gameTime();this._isRunning&&this.currentState()===b&&(this.tickAlpha=this.gameTime()*this.TARGET_TPS/1e3-this.currentTick+1,this.currentState()._draw(this))},a.prototype._requestAnimationFrame=function(){if(this._gameLoop(),this._isRunning)return window.requestAnimationFrame(this._requestAnimationFrame.bind(this))},a.State=function(a){this._init=function(){},this._cleanup=function(){},this._update=function(){},this._draw=function(){},this._pause=function(){},this._resume=function(){},this.name=a,this.data={},this.methods={},this.listeners=[]},a.State.prototype.registerListener=function(a,b,c){this.listeners.push({element:a,eventType:b,callback:c})},a.State.prototype.deregisterListener=function(a,b,c){var d;d=this.listeners.slice(),d.forEach(function(d,e){d.element!==a||d.eventType!==b||d.callback!==c&&void 0!==c||this.listeners.splice(e,1)})},a.State.prototype.init=function(a){return"function"==typeof a&&(this._init=a),this._init},a.State.prototype.cleanup=function(a){return"function"==typeof a&&(this._cleanup=a),this._cleanup},a.State.prototype.update=function(a){return"function"==typeof a&&(this._update=a),this._update},a.State.prototype.draw=function(a){return"function"==typeof a&&(this._draw=a),this._draw},a.State.prototype.pause=function(a){return"function"==typeof a&&(this._pause=a),this._pause},a.State.prototype.resume=function(a){return"function"==typeof a&&(this._resume=a),this._resume},"function"==typeof define&&void 0!==define.amd?define([],function(){return a}):"object"==typeof module&&void 0!==module.exports?module.exports=a:window.Plastick=a}();