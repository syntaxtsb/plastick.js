/*!
 * plastick.js v0.1.0 2014-07-24T23:44:29
 * https://github.com/syntaxtsb/plastick.js
 * 
 * Copyright (c) 2014 Travis Beebe
 * Released under the MIT license.
 */
!function(){"use strict";function a(a){this.GAME_TARGET_TPS=60,this.GAME_TICK_CHOKE=50,this.stage=a,this.data={},this.states=[],this.startTime=null,this.currentTick=0,this.tickTime=0,this.isRunning=!1,this.freezeOnBlur=!0,this._freezeStart=null,this._frameTime=0,this._freezeLength=0,document.addEventListener(c,this._freeze.bind(this))}!function(){if(window.performance=window.performance||{},!window.performance.now){var a=Date.now();window.performance.now=function(){return Date.now()-a}}}();var b,c;"undefined"!==document.hidden?(b="hidden",c="visibilitychange"):"undefined"!==document.mozHidden?(b="mozHidden",c="mozvisibilitychange"):"undefined"!==document.msHidden?(b="msHidden",c="msvisibilitychange"):"undefined"!==document.webkitHidden&&(b="webkitHidden",c="webkitvisibilitychange"),a.prototype.currentState=function(){return this.states[this.states.length-1]},a.prototype.pushState=function(b){var c=this.currentState();return c&&(c._pause(this),this._destroyEventListeners(c)),b instanceof a.State&&(this.states.push(b),b._init(this),this._createEventListeners(b)),b instanceof a.State},a.prototype.popState=function(){var a,b=this.states.pop();return b&&(b._cleanup(this),this._destroyEventListeners(b)),a=this.currentState(),a?(a._resume(this),this._createEventListeners(a)):this.stop(),void 0!==b},a.prototype.changeState=function(b){var c=this.states.pop();return c&&(c._cleanup(this),this._destroyEventListeners(c)),b instanceof a.State&&(this.states.push(b),b._init(this),this._createEventListeners(b)),void 0!==c&&b instanceof a.State},a.prototype.start=function(b){var c=this.isRunning;return b instanceof a.State&&!c?(this.pushState(b),this.isRunning=!0,this.startTime=window.performance.now(),this.tickTime=0,this._frameTime=0,this.stage.draw(this._gameLoop.bind(this)),!0):b instanceof a.State&&!this.wasRunning},a.prototype.stop=function(){var a=this.isRunning;return a&&(this.isRunning=!1,this.stage.stop(),this.cleanup()),a},a.prototype.cleanup=function(){for(;this.states.length;)this.popState();return!0},a.prototype.gameTime=function(){return window.performance.now()-this.startTime-this._freezeLength},a.prototype._freeze=function(){this.freezeOnBlur&&document[b]&&(this._freezeStart=window.performance.now(),this._destroyEventListeners(this.currentState())),this.freezeOnBlur&&!document[b]&&(this._freezeLength+=window.performance.now()-this._freezeStart,this._freezeStart=null,this._createEventListeners(this.currentState()))},a.prototype._createEventListeners=function(a){a.listeners.forEach(function(a){a.element.addEventListener(a.eventType,a.callback)})},a.prototype._destroyEventListeners=function(a){a.listeners.forEach(function(a){a.element.removeEventListener(a.eventType,a.callback)})},a.prototype._gameLoop=function(){var a=0;for(this._frameTime=this.gameTime();this._frameTime*this.GAME_TARGET_TPS/1e3>this.currentTick&&a<this.GAME_TICK_CHOKE;)this.currentTick+=1,a+=1,this.currentState()._update(this),this.tickTime=this.gameTime();this.currentState()._draw(this)},a.State=function(){this._init=function(){return void 0},this._cleanup=function(){return void 0},this._update=function(){return void 0},this._draw=function(){return void 0},this._pause=function(){return void 0},this._resume=function(){return void 0},this.listeners=[]},a.State.prototype.registerListener=function(a,b,c){this.listeners.push({element:a,eventType:b,callback:c})},a.State.prototype.deregisterListener=function(a,b,c){var d;d=this.listeners.slice(),d.forEach(function(d,e){d.element!==a||d.eventType!==b||d.callback!==c&&void 0!==c||this.listeners.splice(e,1)})},a.State.prototype.init=function(a){return"function"==typeof a&&(this._init=a),this._init},a.State.prototype.cleanup=function(a){return"function"==typeof a&&(this._cleanup=a),this._cleanup},a.State.prototype.update=function(a){return"function"==typeof a&&(this._update=a),this._update},a.State.prototype.draw=function(a){return"function"==typeof a&&(this._draw=a),this._draw},a.State.prototype.pause=function(a){return"function"==typeof a&&(this._pause=a),this._pause},a.State.prototype.resume=function(a){return"function"==typeof a&&(this._resume=a),this._resume},"function"==typeof define&&void 0!==define.amd?define([],function(){return a}):"object"==typeof module&&void 0!==module.exports?module.exports=a:window.Plastick=a}();